<% node[:opsworks][:layers]['rails-app'][:instances].each_value.each_with_index do |inst, i| %>
backend server<%= i+1 %> {
  .host = "<%= inst['private_ip'] %>";
}
<% end %>

director backend round-robin {
<% node[:opsworks][:layers]['rails-app'][:instances].length.times do |i| %>
  { .backend = server<%= i+1 %>; }
<% end %>
}

sub vcl_recv {
  set req.backend = backend;
  set req.grace = 1m;

  if (req.url ~ "^/profile_widget" ||
      req.url ~ "^/popular_users_widget" ||
      req.url ~ "^/video_gallery_widget" ||
      req.url ~ "^/feed_widget" ||
      req.url ~ "^/trending_widget" ||
      req.url ~ "^/$") {
    unset req.http.Cookie;
    unset req.http.Authorization;
    return (lookup);
  }
}

# Cookies coming from the backend
sub vcl_fetch {
  set beresp.grace = 1m;

  if (req.url ~ "^/profile_widget" ||
      req.url ~ "^/popular_users_widget" ||
      req.url ~ "^/video_gallery_widget" ||
      req.url ~ "^/feed_widget" ||
      req.url ~ "^/trending_widget" ||
      req.url ~ "^/$") {
    unset beresp.http.Set-Cookie;
    set beresp.http.cache-control = "public, max-age=900";
    set beresp.ttl = 1d;
    return (deliver);
  }
}
